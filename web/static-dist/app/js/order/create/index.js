webpackJsonp(["app/js/order/create/index"],[function(e,o,t){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function a(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}var n=function(){function e(e,o){for(var t=0;t<o.length;t++){var r=o[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(o,t,r){return t&&e(o.prototype,t),r&&e(o,r),o}}(),c=t("b334fd7e4c5a19234db2"),i=(r(c),{divition:function(e,o){return Math.round(Math.round(1e3*e)/Math.round(1e3*o)*1e3)/1e3},multiple:function(e,o){return Math.round(Math.round(100*e)*Math.round(100*o))/1e4},subtract:function(e,o){return Math.round(Math.round(1e3*e)-Math.round(1e3*o))/1e3},moneyFormatFloor:function(e){var o=e+"";return o=parseInt(Math.round(1e3*o)),o=10*parseInt(o/10)/1e3,o.toFixed(2)},moneyFormatCeil:function(e){var o=e+"";o=parseFloat(o).toFixed(3);var t=o.length;return"0"===o.substr(t-1,1)?this.moneyFormatFloor(o):this.moneyFormatFloor(parseFloat(o)+.01)}}),l=function(){function e(o){a(this,e),this.element=$(o.element),this.cashRateElement=$('[role="cash-rate"]'),this.submitBtn="#order-create-btn",this.validator=null,this.cashRate=1,this.init()}return n(e,[{key:"init",value:function(){this.initEvent(),this.initCashRate(),this.validator=this.element.validate({currentDom:this.submitBtn});var e=$("#coupon-select").val();if(""!=e){var o=$('[role="coupon-code-input"]');o.val(e),$('button[role="coupon-use"]').trigger("click")}var t=parseFloat($('[role="total-price"]').text()),r=this;if($('[role="coinNum"]').length>0){var a=$('[role="coinNum"]').val();if(isNaN(a)||a<=0?($(this).val("0.00"),r.coinPriceZero()):r.showPayPassword(),"RMB"==r.cashRateElement.data("priceType")){var n=i.divition(a,r.cashRate);t<n&&(n=t),$('[role="cash-discount"]').text(i.moneyFormatFloor(n)),t=i.subtract(t,n)}else $('[role="cash-discount"]').text(i.moneyFormatFloor(a)),t=i.subtract(t,a)}else $('[role="cash-discount"]').text("0.00");if(this.shouldPay(t),$("#js-order-create-sms-btn").length>0){var c=this;$("#js-order-create-sms-btn").click(function(e){var o=$("#coinPayAmount").val();if(o&&o.length>0&&!isNaN(o)&&o>0&&$("#js-order-create-sms-btn").length>0){if($("#payPassword").trigger("change"),$('[role="password-input"]').find('span[class="text-danger"]').length>0&&e.stopPropagation(),c.validator&&c.validator.form()){var t=$(this),r=t.data("url"),a=$(t.attr("data-target"));a.modal().load(r)}}else e.stopPropagation(),$("#order-create-form").submit()})}}},{key:"initCashRate",value:function(){var e=this.element.find('[role="cash-rate"]');""!=e.val()&&(this.cashRate=e.val(),this.cashRate=parseInt(100*this.cashRate)/100)}},{key:"initEvent",value:function(){var e=this,o=this.element;o.on("blur",'[role="coinNum"]',function(o){return e.coinNumEvent(o)}),o.on("click","#coupon-code-btn",function(o){return e.couponCodeEvent(o)}),o.on("click",'[role="cancel-coupon"]',function(o){return e.couponCancelEvent(o)}),o.on("click",'button[role="coupon-use"]',function(o){return e.couponUseEvent(o)}),o.on("change","#coupon-select",function(o){return e.couponSelectEvent(o)}),o.on("click",this.submitBtn,function(o){return e.formSubmitEvent(o)})}},{key:"formSubmitEvent",value:function(e){this.validator&&this.validator.form()&&this.element.submit()}},{key:"couponSelectEvent",value:function(e){var o=$(e.currentTarget),t=o.children("option:selected");if(""==t.data("code"))return $("[role=no-use-coupon-code]").show(),void $('[role="cancel-coupon"]').trigger("click");$("[role=no-use-coupon-code]").hide();var r=$('[role="coupon-code-input"]');r.val(t.data("code")),$('button[role="coupon-use"]').trigger("click"),$('[role="code-notify"]').removeClass("alert-success")}},{key:"couponUseEvent",value:function(e){var o={},t=$('[role="coupon-code-input"]');if(o.code=t.val(),""==o.code)return void $('[role="coupon-price-input"]').find("[role='price']").text("0.00");o.targetType=t.data("targetType"),o.targetId=t.data("targetId");var r=parseFloat($('[role="total-price"]').text());o.amount=r;var a=this;$.post("/"+o.targetType+"/"+o.targetId+"/coupon/check",o,function(e){$('[role="code-notify"]').css("display","inline-block"),"no"==e.useable?($("[role=no-use-coupon-code]").show(),$('[role="code-notify"]').removeClass("alert-success").addClass("alert-danger").html(Translator.trans("优惠券不可用"))):"yes"==e.useable&&($("[role=no-use-coupon-code]").hide(),$('[role="code-notify"]').removeClass("alert-danger").addClass("alert-success").text(Translator.trans("优惠券可用，您当前使用的是")+("discount"==e.type?Translator.trans("打%rate%折",{rate:e.rate}):Translator.trans("抵价%rate%元",{rate:e.rate}))+Translator.trans("的优惠券")),$('[role="coupon-price"]').find("[role='price']").text(i.moneyFormatFloor(e.decreaseAmount)),$('[role="coupon-code-verified"]').val(t.val())),a.conculatePrice()})}},{key:"couponCancelEvent",value:function(e){if(""!=$("#coupon-select").val()){var o=$("#coupon-select").val(),t=$('[role="coupon-code-input"]');t.val(o),$('button[role="coupon-use"]').trigger("click")}$('[role="coupon-code"]').hide(),$("#coupon-code-btn").show(),$('[role="null-coupon-code"]').show(),$('[role="code-notify"]').hide(),$('[role="coupon-price"]').find("[role='price']").text("0.00"),$('[role="code-notify"]').text(""),$('[role="coupon-code"]').val(""),$(this).hide(),$('[role="coupon-code-verified"]').val(""),$('[role="coupon-code-input"]').val(""),this.conculatePrice()}},{key:"coinNumEvent",value:function(e){var o=$(e.currentTarget),t=o.val();t=Math.round(100*t)/100,o.val(t),isNaN(t)||t<=0?(o.val("0.00"),this.coinPriceZero()):this.showPayPassword(),this.conculatePrice()}},{key:"couponCodeEvent",value:function(e){var o=$(e.currentTarget);$('[role="coupon-price"]').find("[role='price']").text("0.00"),$('[role="code-notify"]').text("").removeClass("alert-success"),$('[role="coupon-code"]').val(""),$('[role="cancel-coupon"]').hide(),$('[role="coupon-code-verified"]').val(""),$('[role="coupon-code-input"]').val(""),this.conculatePrice(),$('[role="coupon-code"]').show(),$('[role="coupon-code-input"]').focus(),$('[role="cancel-coupon"]').show(),$('[role="null-coupon-code"]').hide(),o.hide()}},{key:"afterCouponPay",value:function(e){var o=$('[role="coupon-price"]').find("[role='price']").text();return(""==$.trim(o)||isNaN(o))&&(o=0),e<o&&(o=e),e=i.subtract(e,o)}},{key:"afterCoinPay",value:function(e){var o=$('[role="accountCash"]').text();if(""==o||isNaN(o)||0==parseFloat(o))return this.coinPriceZero(),0;var t=Math.round(1e3*o)>Math.round(1e3*e)?e:o;if("RMB"==this.cashRateElement.data("priceType")){var r=parseFloat($('[role="total-price"]').text()),a=Math.round(100*i.moneyFormatFloor(i.divition(t,this.cashRate)))/100;r<a&&(a=r),$('[role="cash-discount"]').text(i.moneyFormatFloor(a))}else $('[role="cash-discount"]').text(i.moneyFormatFloor(t));return t}},{key:"getMaxCoinCanPay",value:function(e){var o=parseFloat($('[role="maxCoin"]').text()),t=e<o?e:o,r=$('[role="accountCash"]');if(r.length>0){var a=parseFloat(100*r.text())/100;t=t<a?t:a}return t}},{key:"shouldPay",value:function(e){if(e=Math.round(1e3*e)/1e3,"RMB"==this.cashRateElement.data("priceType"))e=i.moneyFormatCeil(e),$('[role="pay-rmb"]').text(e),$('input[name="shouldPayMoney"]').val(e);else{var o=i.moneyFormatCeil(i.divition(e,this.cashRate)),t=Math.round(100*o)/100;$('[role="pay-coin"]').text(e),$('[role="pay-rmb"]').text(t),$('input[name="shouldPayMoney"]').val(t)}}},{key:"conculatePrice",value:function(){var e=parseFloat($('[role="total-price"]').text());e=this.afterCouponPay(e);var o=this.cashRateElement.data("cashModel");switch(o){case"none":e=e>=0?e:0,this.shouldPay(e);break;case"deduction":var t=i.multiple(e,this.cashRate);t=i.moneyFormatCeil(t);var r=this.getMaxCoinCanPay(t),a=$('[role="coinNum"]').val();if(r<=parseFloat(a)&&(a=r),$('[role="coinNum"]').val(a),0==a&&this.coinPriceZero(),a&&$('[name="payPassword"]').length>0){a=this.afterCoinPay(a);var n=$('[role="cash-discount"]').text();e=i.subtract(e,n)}else $('[role="coinNum"]').val(0),$('[role="cash-discount"]').text("0.00");e=e>=0?e:0,this.shouldPay(e);break;case"currency":var t=e,a=$('[role="coinNum"]').val();if(t<=parseFloat(a)&&(a=t),$('[role="coinNum"]').val(a),0==a&&this.coinPriceZero(),a&&$('[name="payPassword"]').length>0){a=this.afterCoinPay(a);var n=$('[role="cash-discount"]').text();e=i.subtract(e,n)}else $('[role="coinNum"]').val(0),$('[role="cash-discount"]').text("0.00");e=e>=0?e:0,this.shouldPay(e)}}},{key:"coinPriceZero",value:function(){$('[role="coinNum"]').val(0),$('[role="cash-discount"]').data("defaultValue"),$("[role='password-input']").hide(),$('[name="payPassword"]').rules("remove","required passwordCheck")}},{key:"showPayPassword",value:function(){$("[role='password-input']").show(),$('[name="payPassword"]').rules("add",{required:!0,passwordCheck:!0})}}]),e}();new l({element:"#order-create-form"})}]);